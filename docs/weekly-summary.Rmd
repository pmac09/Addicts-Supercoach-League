---
title: "Fantasy Banter"
---

```{r, setup, echo=FALSE, include=FALSE}
options(stringsAsFactors = FALSE)

library(tidyverse)
library(highcharter)
library(zoo)
library(janitor)
library(shiny)
library(DT)
library(kableExtra)

```

```{r, echo=FALSE,include=FALSE}
source('/Users/paulmcgrath/Github/Addicts-Supercoach-League/functions/supercoach_functions.R')

#player_data <- get_player_data(cid,tkn)
#fixture_data <- get_fixture_data(cid, tkn)

#saveRDS(player_data, '../data/2021/player_data.RDS')
#saveRDS(fixture_data, '../data/2021/fixture_data.RDS')

player_data <- readRDS('../data/2021/player_data.RDS')
fixture_data <- readRDS('../data/2021/fixture_data.RDS')

```

## Score Summary
```{r, boxplots, echo=FALSE}

boxplot_data <- fixture_data %>%
  filter(!is.na(team_score)) %>%
  filter(team_score > 0)
  
box_summary <- boxplot(team_score ~ coach, data = boxplot_data, range=3, plot=FALSE)
box_order <- rev(order(box_summary$stats[3,]))
box_data <- t(box_summary$stats[,box_order])
rownames(box_data) <- box_summary$names[box_order]

highchart() %>%
  hc_chart(type = 'boxplot') %>%
  hc_xAxis(categories = box_summary$names[box_order]) %>%
  hc_add_series(data=box_data)

```

## Power Rankings
```{r, power_rankings, echo=FALSE}

rankings_data <- fixture_data %>%
  filter(!is.na(team_score)) %>%
  filter(team_score > 0) %>%
  select(round, team, coach, team_score) %>% 
  arrange(coach, round) %>%
  group_by(coach) %>%
  mutate(avg3 = round(rollapply(team_score,3,mean,align='right',fill='extend'),1)) %>%
  ungroup() %>%
  select(round, coach, avg3) %>%
  spread(coach, avg3)

#  rank(rankings_data[nrow(rankings_data),c(2:9)]) -
# rank(rankings_data[nrow(rankings_data)-1,c(2:9)])

highchart() %>%
  hc_chart(type = 'spline') %>%
  hc_xAxis(categories=rankings_data$round) %>%
  hc_add_series(name=colnames(rankings_data)[2], data=rankings_data$Anthony) %>%
  hc_add_series(name=colnames(rankings_data)[3], data=rankings_data$James)  %>%
  hc_add_series(name=colnames(rankings_data)[4], data=rankings_data$Jordan)  %>%
  hc_add_series(name=colnames(rankings_data)[5], data=rankings_data$Lester)  %>%
  hc_add_series(name=colnames(rankings_data)[6], data=rankings_data$Luke)  %>%
  hc_add_series(name=colnames(rankings_data)[7], data=rankings_data$Mark)  %>%
  hc_add_series(name=colnames(rankings_data)[8], data=rankings_data$Paul)  %>%
  hc_add_series(name=colnames(rankings_data)[9], data=rankings_data$Simon) 

```

## Fixture Strength
```{r, fixture_strength, echo=FALSE}

fs <- fixture_data %>%
  filter(!is.na(team_score)) %>%
  filter(team_score > 0) %>%
  group_by(round) %>%
  mutate(score_rank = rank(-team_score)) %>%
  mutate(opp_score_rank = rank(-opponent_score)) %>%
  ungroup() %>%
  group_by(coach) %>%
  summarise(
    avg_rank = round(mean(score_rank),1),
    avg_opp_rank = round(mean(opp_score_rank),1)
  ) %>%
  arrange(avg_rank)

highchart() %>%
  hc_chart(type = 'bar') %>%
  hc_title(text = 'Season Performance') %>%
  hc_subtitle(text= 'Average Rank of Weekly Scores') %>%
  hc_legend(enabled=FALSE) %>%
  hc_xAxis(categories=fs$coach) %>%
  hc_yAxis(min=1) %>%
  hc_add_series(data=fs$avg_rank, color='green')

fs <- fs %>%
  arrange(avg_opp_rank)

highchart() %>%
  hc_chart(type = 'bar') %>%
  hc_title(text = 'Fixture Difficulty') %>%
  hc_subtitle(text= "Average Rank of Opponent's Weekly Scores") %>%
  hc_legend(enabled=FALSE) %>%
  hc_xAxis(categories=fs$coach) %>%
  hc_yAxis(min=1) %>%
  hc_add_series(data=fs$avg_opp_rank, color='red')

```

## ASL Team of the Week
```{r, team_of_the_week, echo=FALSE}

totw_data <- player_data %>%
  filter(!is.na(team)) %>%
  filter(type == 'scoring') %>%
  arrange(round, position, desc(points), desc(avg)) %>%
  group_by(round, position) %>%
  mutate(rank = rank(-points, ties.method='first')) %>%
  filter((position == 'DEF' & rank <= 5)|
         (position == 'MID' & rank <= 7)|
         (position == 'RUC' & rank <= 1)|
         (position == 'FWD' & rank <= 5)) %>%
  ungroup()
           
totw_summary <- totw_data %>%
  group_by(coach, position) %>%
  summarise(
    n = n(),
    .groups='drop'
  ) %>%
  spread(coach, n) %>%
  adorn_totals('row')

totw <- totw_data %>%
  filter(round == max(round)) %>%
  mutate(name=paste0(substr(first_name,1,1),'.',last_name))

totw <- bind_rows(totw[totw$position!='FWD',], totw[totw$position=='FWD',]) 
```

```{css, echo=FALSE}

.field-container {
  margin: auto;
  width: 100%;
  max-width: 650px;
  background-image: linear-gradient(180deg, #b7e66e, #5bacb1);
  justify-content: center;
  display: flex;
}

.field-image {
  background-image: url('images/afl_field.png');
  background-size: 100% 100%;
  background-position: center;
  background-repeat: no-repeat;
}

.position-container{
  display: flex;
  flex-direction: column;
  flex-wrap: nowrap;
  justify-content: center;
  max-width: 500px;
}

.position-header{
  display: flex;
  justify-content: center;
  background-color: black;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  height: 21px;
  width: 100px;
  text-transform: capitalize;
  overflow: hidden;
  padding: 3px;
  white-space: nowrap;
  color: #fff;
  text-align: center;
}

.position-row{
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  justify-content: center;
}

.player-cell{
  margin:5px;
  height:50px;
  width:124px;
  background: blue;
  overflow: hidden;
  border-radius: 6px;
  position:relative;
  background-color: rgba(60, 179, 113,0.7);
}

.player-img{
  float:right;
}

.player-img img{
  height:50px;
}

.player-name{
  height:35%;
  width:100%;
  font-size:12px;
  font-weight: 700;
  white-space: nowrap;
  background-color: #09913f;
  color:#fff;
  padding:1px 4px;
}

.player-score{
  height:65%;
  width: 60%;
  font-size:20px;
  padding:0px 4px;
  font-weight: 500;
}

.field-spacer{
  height: 21px;
}
```

### Round `r max(totw$round)` Score: `r sum(totw$points)`
```{r, totw_field, echo=FALSE}
div(
  div(class='field-container',
    div(class='field-image',
        
      div(class='field-spacer'),
      div(class='position-container',
        div(class='position-row', div(class='position-header','DEFENDERS')),
        div(class='position-row',
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[1],'.png'))),
            div(class='player-name', totw$name[1]),
            div(class='player-score', totw$points[1]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[2],'.png'))),
            div(class='player-name', totw$name[2]),
            div(class='player-score', totw$points[2]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[3],'.png'))),
            div(class='player-name', totw$name[3]),
            div(class='player-score', totw$points[3]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[4],'.png'))),
            div(class='player-name', totw$name[4]),
            div(class='player-score', totw$points[5]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[5],'.png'))),
            div(class='player-name', totw$name[5]),
            div(class='player-score', totw$points[5]),
          )
        )
      ),
      
      div(class='field-spacer'),
      div(class='position-container',
        div(class='position-row', div(class='position-header','MIDFIELDERS')),
        div(class='position-row',
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[6],'.png'))),
            div(class='player-name', totw$name[6]),
            div(class='player-score', totw$points[6]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[7],'.png'))),
            div(class='player-name', totw$name[7]),
            div(class='player-score', totw$points[7]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[8],'.png'))),
            div(class='player-name', totw$name[8]),
            div(class='player-score', totw$points[8]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[9],'.png'))),
            div(class='player-name', totw$name[9]),
            div(class='player-score', totw$points[9]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[10],'.png'))),
            div(class='player-name', totw$name[10]),
            div(class='player-score', totw$points[10]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[11],'.png'))),
            div(class='player-name', totw$name[11]),
            div(class='player-score', totw$points[11]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[12],'.png'))),
            div(class='player-name', totw$name[12]),
            div(class='player-score', totw$points[12]),
          )
        )
      ),
      
      div(class='field-spacer'),
      div(class='position-container',
        div(class='position-row', div(class='position-header','RUCKS')),
        div(class='position-row',
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[13],'.png'))),
            div(class='player-name', totw$name[13]),
            div(class='player-score', totw$points[13]),
          )
        )
      ),
      
      div(class='field-spacer'),
      div(class='position-container',
        div(class='position-row', div(class='position-header','FORWARDS')),
        div(class='position-row',
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[14],'.png'))),
            div(class='player-name', totw$name[14]),
            div(class='player-score', totw$points[14]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[15],'.png'))),
            div(class='player-name', totw$name[15]),
            div(class='player-score', totw$points[15]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[16],'.png'))),
            div(class='player-name', totw$name[16]),
            div(class='player-score', totw$points[16]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[17],'.png'))),
            div(class='player-name', totw$name[17]),
            div(class='player-score', totw$points[17]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',totw$feed_id[18],'.png'))),
            div(class='player-name', totw$name[18]),
            div(class='player-score', totw$points[18]),
          )
        )
      ),
      
      div(class='field-spacer')
    )
  ),
  div(class='field-spacer')
)
```
```{r, totw_round, echo=FALSE}

totw_round <- totw_data %>%
  group_by(coach, round) %>%
  summarise(
    n = n(),
    .groups='drop'
  ) %>%
  spread(round, n) %>%
  adorn_totals(where='col') %>%
  arrange(desc(Total))

totw_round[is.na(totw_round)] <- 0

totw_round_hc <- totw_round %>%
  select(-Total) %>%
  pivot_longer(cols = -coach, names_to = "round", values_to = "n", names_pattern = "(\\d)$") %>%
  group_by(round) %>%
  do(data = list_parse2(data.frame(.$coach, .$n))) %>%
  ungroup() %>%
  rename(name = round)

highchart() %>%
  hc_chart(type = 'bar') %>%
  hc_title(text = 'Nominations by Round') %>%
  hc_subtitle(text= 'Team of the Week') %>%
  hc_plotOptions(series=list(stacking='normal')) %>%
  hc_xAxis(categories=totw_round$coach) %>%
  hc_add_series_list(totw_round_hc)
  
```
```{r, totw_pos, echo=FALSE}

totw_pos <- totw_data %>%
  group_by(coach,position) %>%
  summarise(
    n = n(),
    .groups='drop'
  ) %>%
  spread(position, n) %>%
  adorn_totals(where='col') %>%
  arrange(desc(Total))

totw_pos[is.na(totw_pos)] <- 0

totw_pos_hc <- totw_pos  %>%
  select(-Total) %>%
  pivot_longer(cols = -coach, names_to = "position", values_to = "n") %>%
  group_by(position) %>%
  do(data = list_parse2(data.frame(.$coach, .$n))) %>%
  ungroup() %>%
  rename(name = position)

highchart() %>%
  hc_chart(type = 'bar') %>%
  hc_title(text = 'Nominations by Position') %>%
  hc_subtitle(text= 'Team of the Week') %>%
  hc_plotOptions(series=list(stacking='normal')) %>%
  hc_xAxis(categories=totw_round$coach) %>%
  hc_add_series_list(totw_pos_hc)

```

## The Mcgoos of the Week
```{r, mcgoos_of_the_week, echo=FALSE}

motw_data <- player_data %>%
  mutate(name = paste0(substr(first_name,1,1),'.',last_name)) %>%
  mutate(last_round = round-1) %>%
  select(feed_id, name, pos_1, team, round, points, last_round) %>%
  inner_join(player_data[,c('feed_id','round','avg')], by=c('feed_id', 'last_round'='round')) %>%
  filter(is.na(team)) %>%
  filter(!is.na(points)) %>%
  arrange(round, pos_1, desc(avg), desc(points)) %>%
  group_by(round, pos_1) %>%
  mutate(rank = rank(-avg, ties.method = 'first')) %>%
  ungroup() %>%
  filter((pos_1 == 'DEF' & rank <= 5)|
         (pos_1 == 'MID' & rank <= 7)|
         (pos_1 == 'RUC' & rank <= 1)|
         (pos_1 == 'FWD' & rank <= 5)) 
           
motw_summary <- motw_data %>%
  group_by(round) %>%
  summarise(
    score = sum(points),
    .groups='drop'
  )

motw <- motw_data %>%
  filter(round == max(round))

motw <- bind_rows(motw[motw$pos_1!='FWD',], motw[motw$pos_1=='FWD',]) 

```
The Mcgoos are the highest averaging players from last round that were available on the waiver this week. These spuds are doing their best to prove themselves and fight their way onto an ASL list. Similar to the Herald Sun's "Kiss of Death", you wouldn't want to be outscored by this team.

### Round `r max(motw$round)` Score: `r sum(motw$points)`
```{r, motw_field, echo=FALSE}
div(
  div(class='field-container',
    div(class='field-image',
        
      div(class='field-spacer'),
      div(class='position-container',
        div(class='position-row', div(class='position-header','DEFENDERS')),
        div(class='position-row',
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[1],'.png'))),
            div(class='player-name', motw$name[1]),
            div(class='player-score', motw$points[1]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[2],'.png'))),
            div(class='player-name', motw$name[2]),
            div(class='player-score', motw$points[2]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[3],'.png'))),
            div(class='player-name', motw$name[3]),
            div(class='player-score', motw$points[3]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[4],'.png'))),
            div(class='player-name', motw$name[4]),
            div(class='player-score', motw$points[5]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[5],'.png'))),
            div(class='player-name', motw$name[5]),
            div(class='player-score', motw$points[5]),
          )
        )
      ),
      
      div(class='field-spacer'),
      div(class='position-container',
        div(class='position-row', div(class='position-header','MIDFIELDERS')),
        div(class='position-row',
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[6],'.png'))),
            div(class='player-name', motw$name[6]),
            div(class='player-score', motw$points[6]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[7],'.png'))),
            div(class='player-name', motw$name[7]),
            div(class='player-score', motw$points[7]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[8],'.png'))),
            div(class='player-name', motw$name[8]),
            div(class='player-score', motw$points[8]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[9],'.png'))),
            div(class='player-name', motw$name[9]),
            div(class='player-score', motw$points[9]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[10],'.png'))),
            div(class='player-name', motw$name[10]),
            div(class='player-score', motw$points[10]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[11],'.png'))),
            div(class='player-name', motw$name[11]),
            div(class='player-score', motw$points[11]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[12],'.png'))),
            div(class='player-name', motw$name[12]),
            div(class='player-score', motw$points[12]),
          )
        )
      ),
      
      div(class='field-spacer'),
      div(class='position-container',
        div(class='position-row', div(class='position-header','RUCKS')),
        div(class='position-row',
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[13],'.png'))),
            div(class='player-name', motw$name[13]),
            div(class='player-score', motw$points[13]),
          )
        )
      ),
      
      div(class='field-spacer'),
      div(class='position-container',
        div(class='position-row', div(class='position-header','FORWARDS')),
        div(class='position-row',
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[14],'.png'))),
            div(class='player-name', motw$name[14]),
            div(class='player-score', motw$points[14]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[15],'.png'))),
            div(class='player-name', motw$name[15]),
            div(class='player-score', motw$points[15]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[16],'.png'))),
            div(class='player-name', motw$name[16]),
            div(class='player-score', motw$points[16]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[17],'.png'))),
            div(class='player-name', motw$name[17]),
            div(class='player-score', motw$points[17]),
          ),
          div(class='player-cell',
            div(class='player-img', img(src = paste0('https://s.afl.com.au/staticfile/AFL%20Tenant/AFL/Players/ChampIDImages/XLarge2021/',motw$feed_id[18],'.png'))),
            div(class='player-name', motw$name[18]),
            div(class='player-score', motw$points[18]),
          )
        )
      ),
      
      div(class='field-spacer')
    )
  ),
  div(class='field-spacer')
)
```




## Wish list
- injury assessment
- trade tracker
- positional averages
- draft heat map
- simulations/to make finals
- ladder predictor
- ladder journey
- records
- H2H matchups 
- B&F
